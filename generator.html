<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Choices.js for searchable dropdowns - Load with preconnect and preload -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" as="script">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" media="print" onload="this.media='all'">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="theme-color" content="#3498db">
    <title>PowerBall Random Generator</title>
    <link rel="stylesheet" href="style.css" media="print" onload="this.media='all'">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
      body {
        background: linear-gradient(120deg, #f0f4ff 0%, #fff 100%);
      }
      .generator-container {
        max-width: 900px;
        margin: 20px auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(44,62,80,0.10);
        padding: 24px 16px;
        transition: all 0.3s ease;
        will-change: transform, box-shadow;
      }
      .generator-title {
        text-align: center;
        font-size: 2.1em;
        font-weight: 700;
        color: #234;
        margin-bottom: 18px;
        letter-spacing: 0.5px;
      }
      .generator-flex-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 32px 24px;
        justify-content: center;
      }
      .generator-section {
        flex: 1 1 320px;
        min-width: 320px;
        max-width: 420px;
        margin-bottom: 0;
      }
      .generator-panel {
        background: #f8faff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(44,62,80,0.04);
        padding: 24px 18px 18px 18px;
        margin-bottom: 0;
      }
      .generator-panel h2 {
        font-size: 1.25em;
        font-weight: 600;
        color: #3498db;
        margin-bottom: 16px;
      }
      .multi-gen-btn, .freq-gen-btn, #build-duo-combo-btn, #build-combo-btn {
        background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 1.08em;
        font-weight: 600;
        margin: 0 0 12px 0;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(44,62,80,0.08);
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        min-height: 44px; /* Minimum touch target size */
        width: 100%;
        display: block;
      }
      .multi-gen-btn:hover, .freq-gen-btn:hover, #build-duo-combo-btn:hover, #build-combo-btn:hover {
        background: linear-gradient(90deg, #217dbb 0%, #3498db 100%);
        box-shadow: 0 4px 16px rgba(44,62,80,0.13);
      }
      /* Mobile-first responsive design */
      @media (max-width: 480px) {
        .generator-container {
          padding: 8px 4px 16px 4px;
          margin: 16px 8px;
          width: calc(100% - 24px);
          box-sizing: border-box;
        }
        .generator-title {
          font-size: 1.6em;
          padding: 0 8px;
        }
        .tab-nav {
          flex-wrap: wrap;
          padding: 6px 4px;
          gap: 6px;
        }
        .tab-btn {
          padding: 8px 12px;
          font-size: 1em;
          flex: 1 0 calc(50% - 12px);
          text-align: center;
        }
        .generator-panel {
          padding: 16px 12px;
          margin: 0 4px;
          width: calc(100% - 32px);
        }
        .multi-gen-btn, .freq-gen-btn, #build-duo-combo-btn, #build-combo-btn {
          width: 100%;
          margin: 0 0 10px 0;
          padding: 12px;
          font-size: 1.1em;
        }
        .pills-container {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 8px;
        }
      }

      @media (min-width: 481px) and (max-width: 768px) {
        .generator-container {
          padding: 16px 12px;
          margin: 20px 12px;
          width: calc(100% - 48px);
        }
        .generator-title {
          font-size: 1.8em;
        }
        .tab-btn {
          padding: 8px 14px;
          font-size: 1.05em;
        }
      }

      @media (min-width: 769px) {
        .generator-container {
          max-width: 900px;
          margin: 40px auto;
          padding: 32px 18px;
        }
      }
      .back-link {
        display: block;
        margin: 32px auto 0 auto;
        color: #3498db;
        font-weight: 600;
        text-decoration: none;
        text-align: center;
        width: 100%;
        font-size: 1.08em;
      }
      .tab-nav {
        display: flex;
        justify-content: center;
        gap: 0 18px;
        margin-bottom: 24px;
        background: #f8faff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(44,62,80,0.04);
        padding: 10px 0;
      }
      .tab-btn {
        background: none;
        border: none;
        color: #234;
        font-size: 1.08em;
        font-weight: 600;
        padding: 8px 18px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.13s, color 0.13s;
      }
      .tab-btn.active {
        background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
        color: #fff;
      }
      .tab-btn:not(.active):hover {
        background: #eaf3fb;
        color: #3498db;
      }
      /* Make all balls bold throughout the page */
      .generated-ball, .red-ball, .ball, .yellow-ball {
        font-weight: bold !important;
      }
      /* Make selection pills more visually clear */
      .pill-btn.selected {
        background: linear-gradient(90deg, #ffe066 0%, #e67e22 100%) !important;
        color: #222 !important;
        border: 2px solid #e67e22 !important;
        box-shadow: 0 0 0 3px #ffe06699, 0 2px 8px rgba(230, 126, 34, 0.13);
        font-weight: bold;
        outline: none;
      }
      /* Enhanced Section 2: Create Combination from 2 Duos */
      #duo-builder-panel {
        background: #f4faff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(52,152,219,0.08);
        padding: 28px 22px 22px 22px;
        margin-bottom: 0;
        max-width: 420px;
        margin-left: auto;
        margin-right: auto;
      }
      #duo-builder-panel h2 {
        color: #217dbb;
        font-size: 1.22em;
        font-weight: 700;
        margin-bottom: 18px;
        letter-spacing: 0.5px;
      }
      .duo-select-label {
        font-size: 1.07em;
        font-weight: 600;
        color: #234;
        margin-bottom: 6px;
        display: block;
      }
      .duo-select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1.5px solid #b3d6f2;
        font-size: 1.08em;
        margin-bottom: 16px;
        background: #fff;
        transition: border 0.15s;
      }
      .duo-select:focus {
        border: 1.5px solid #3498db;
        outline: none;
      }
      #build-duo-combo-btn {
        width: 100%;
        font-size: 1.13em;
        padding: 12px 0;
        border-radius: 10px;
        margin-top: 10px;
        margin-bottom: 0;
      }
      #built-duo-combo-result {
        margin-top: 22px !important;
        background: #eaf6fb;
        border-radius: 10px;
        padding: 18px 12px;
        min-height: 36px;
        font-size: 1.09em;
        color: #234;
        box-shadow: 0 1px 4px rgba(52,152,219,0.07);
      }
      /* Pills container styling */
      /* Enhanced Pills Container */
      .pills-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin: 12px 0 20px 0;
      }
      
      /* Pill Buttons */
      .pill-btn {
        background: #f0f7ff;
        border: 1px solid #d0e3ff;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.95em;
        color: #2c5282;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .pill-btn:hover {
        background: #e1f0ff;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      
      .pill-btn.selected {
        background: #3182ce;
        color: white;
        border-color: #2c5282;
        font-weight: 600;
      }
      
      /* Section Headers */
      .section-header {
        font-size: 1.1em;
        font-weight: 600;
        color: #2d3748;
        margin: 20px 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
      }
      
      /* Frequency Badge */
      .frequency-badge {
        display: inline-block;
        background: #ebf8ff;
        color: #2b6cb0;
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 6px;
        font-weight: 600;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .pills-container {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
      }
      
      @media (max-width: 480px) {
        .pills-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      /* Pill button styling */
      .pill-btn {
        background: #f0f7ff;
        border: 1.5px solid #cce0f7;
        border-radius: 16px;
        padding: 8px 14px;
        font-size: 0.95em;
        font-weight: 500;
        color: #2c3e50;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      
      .pill-btn:hover {
        background: #e1f0ff;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      }
      
      .pill-btn.selected {
        background: linear-gradient(135deg, #4a90e2 0%, #5ab0f4 100%);
        color: white;
        border-color: #3a7bc8;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(74, 144, 226, 0.25);
      }
      
      /* Section 3: Create Combination from 1 Duo and 1 Trio */
      #combo-builder-panel {
        background: #f9fcff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(74, 144, 226, 0.08);
        padding: 28px 22px 22px 22px;
        margin-top: 24px;
      }
      
      #combo-builder-panel h2 {
        color: #2c6aa0;
        font-size: 1.22em;
        font-weight: 700;
        margin-bottom: 18px;
        letter-spacing: 0.5px;
      }
      
      /* 2x Results Modern Style */
      .twox-combo-results-list {
        margin-top: 18px;
        background: #f8faff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(44,62,80,0.06);
        padding: 18px 14px 10px 14px;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
      }
      .twox-combo-row {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.13em;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e3eaf2;
      }
      .twox-combo-row:last-child {
        border-bottom: none;
      }
      .twox-combo-label {
        font-weight: 600;
        color: #217dbb;
        min-width: 140px;
        display: inline-block;
      }
      .twox-red-ball {
        display: inline-block;
        background: linear-gradient(120deg, #e74c3c 60%, #ffb3b3 100%);
        color: #fff;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        font-size: 1.08em;
        font-weight: bold;
        margin-right: 4px;
        box-shadow: 0 2px 8px rgba(231,76,60,0.10);
        border: 2px solid #e74c3c;
      }
      /* 2x Sets Interactive Panel and Results */
      #twox-interactive-panel {
        background: #f8faff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(52,152,219,0.08);
        padding: 24px 18px 18px 18px;
        margin-bottom: 24px;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
      }
      #twox-ball-select {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 18px;
        justify-content: center;
      }
      .twox-ball {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #fff;
        border: 2px solid #e74c3c;
        color: #e74c3c;
        font-weight: bold;
        font-size: 1.08em;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.15s, color 0.15s, border 0.15s;
      }
      .twox-ball.selected {
        background: #e74c3c;
        color: #fff;
        border: 2px solid #c0392b;
        box-shadow: 0 2px 8px rgba(231,76,60,0.13);
      }
      #twox-results-panel {
        background: #f4faff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(52,152,219,0.07);
        padding: 18px 14px;
        margin-top: 18px;
        min-height: 60px;
      }
      .twox-combo-row {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.13em;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e3eaf2;
      }
      .twox-combo-row:last-child {
        border-bottom: none;
      }
      .twox-combo-label {
        font-weight: 600;
        color: #217dbb;
        min-width: 170px;
        display: inline-block;
      }
      .twox-red-ball {
        display: inline-block;
        background: linear-gradient(120deg, #e74c3c 60%, #ffb3b3 100%);
        color: #fff;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        font-size: 1.08em;
        font-weight: bold;
        margin-right: 4px;
        box-shadow: 0 2px 8px rgba(231,76,60,0.10);
        border: 2px solid #e74c3c;
      }
    </style>
</head>
<body>
    <div class="generator-container">
      <div class="generator-title">Random Number Generator</div>
      <nav class="tab-nav">
        <button class="tab-btn" data-tab="home">Quick Generator</button>
      </nav>
      <div id="home-tab" class="tab-content" style="display:block;">
      </div>
      <div id="history-tab" class="tab-content" style="display:none;">
        <div id="history-content"></div>
      </div>
      <div class="generator-flex-layout">
          <!-- Section 1: Quick Random Generator -->
          <section class="generator-section">
            <div class="generator-panel">
              <h2>1. Quick Random Generator</h2>
              <div style="margin-bottom: 18px;">
                <button class="multi-gen-btn" data-count="4">Generate 4</button>
                <button class="multi-gen-btn" data-count="8">Generate 8</button>
                <button class="multi-gen-btn" data-count="16">Generate 16</button>
                <button id="generate-from-trios" class="multi-gen-btn" style="background: #9b59b6; color: white; margin-bottom: 8px;">From Frequent Trios</button>
                <button id="generate-from-overlapping-trios" class="multi-gen-btn" style="background: #e74c3c; color: white;">From Overlapping Trios</button>
              </div>
              <div id="generated-table" style="margin-top:18px; min-height: 200px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"></div>
              <div id="csv-loading" style="margin-top:10px; color:#888; font-size:1.05em;"></div>
              <div style="margin-top:18px; color:#888; font-size:1.05em;">Each combination: 5 unique numbers (1-69).</div>
            </div>
          </section>
          <!-- Section 2: Create Combination from 2 Duos (dropdown UI) -->
          <section class="generator-section">
            <div class="generator-panel" id="duo-builder-panel">
              <h2>2. Create Combination from 2 Duos</h2>
              <label for="duo1-select" class="duo-select-label">Select Duo 1:</label>
              <select id="duo1-select" class="duo-select"></select>
              <label for="duo2-select" class="duo-select-label">Select Duo 2:</label>
              <select id="duo2-select" class="duo-select"></select>
              <button id="build-duo-combo-btn" class="freq-gen-btn" disabled>Generate from Two Duos</button>
<button id="clear-duo-selection-btn" class="multi-gen-btn" style="margin-top:8px; background: #eee; color: #217dbb; border: 1.5px solid #b3d6f2;">Clear Selection</button>
<div id="built-duo-combo-result"></div>
            </div>
          </section>
          <!-- Section 3: Create Combination from 1 Duo and 1 Trio -->
          <section class="generator-section">
            <div class="generator-panel" id="combo-builder-panel">
  <h2>3. Create Combination from 1 Duo and 1 Trio</h2>
  <label for="combo-duo-select" class="duo-select-label">Select Duo:</label>
  <select id="combo-duo-select" class="duo-select"></select>
  <label for="combo-trio-select" class="duo-select-label">Select Trio:</label>
  <select id="combo-trio-select" class="duo-select"></select>
  <button id="build-combo-btn" class="freq-gen-btn" style="margin-top:8px;" disabled>Generate from Duo + Trio</button>
  <button id="clear-combo-selection-btn" class="multi-gen-btn" style="margin-top:8px; background: #eee; color: #217dbb; border: 1.5px solid #b3d6f2;">Clear Selection</button>
  <div id="built-combo-result" style="margin-top:18px;"></div>
</div>
          </section>
        </div>

        <a href="index.html" class="back-link">&larr; Back to Main</a>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    let historicalCombos = [];
    let allMainDraws = [];
    const csvLoading = document.getElementById('csv-loading');
    // Load and parse the CSV file
    csvLoading.textContent = 'Loading historical Powerball data...';
    fetch('powerball.csv')
        .then(response => response.text())
        .then(rawCsv => {
            // Clean the CSV: remove all quotes, trim spaces, standardize header
            let lines = rawCsv.split('\n').map(line => line.replace(/"/g, '').trim());
            if (lines[0].toLowerCase().includes('date') && lines[0].toLowerCase().includes('winning numbers')) {
                lines[0] = 'Date,Winning Numbers,Powerball,PowerPlay';
            }
            lines = lines.map(line => line.split(',').map(f => f.trim()).join(','));
            const cleanedCsv = lines.join('\n');
            Papa.parse(cleanedCsv, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    // Extract all main draw combinations
                    historicalCombos = [];
                    allMainDraws = [];
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i];
                        const dateStr = (row.Date || '').trim();
                        const parts = dateStr.split('/');
                        const year = parts.length === 3 ? parseInt(parts[2], 10) : 0;
                        // Main draw row
                        if (row.Date && year >= 2016 && row['Winning Numbers'] && row['Winning Numbers'].toLowerCase().includes('powerball')) {
                            let winNumbers = row['Winning Numbers'].replace(/®/g, '').replace(/Powerball.*Numbers\s*/i, '').trim();
                            let mainArr = winNumbers.split(' - ').map(x => parseInt(x.trim(), 10)).filter(n => n >= 1 && n <= 69);
                            if (mainArr.length === 5) {
                                historicalCombos.push({
                                    combo: mainArr.slice().sort((a,b)=>a-b).join('-')
                                });
                                allMainDraws.push({ arr: mainArr, year });
                            }
                            // Check next row for Double Play
                            if (i + 1 < data.length) {
                                const nextRow = data[i + 1];
                                if (!nextRow.Date && nextRow['Winning Numbers'] && nextRow['Winning Numbers'].toLowerCase().includes('double play')) {
                                    let doubleNumbers = nextRow['Winning Numbers'].replace(/®/g, '').replace(/Double Play.*Numbers\s*/i, '').trim();
                                    let doubleArr = doubleNumbers.split(' - ').map(x => parseInt(x.trim(), 10)).filter(n => n >= 1 && n <= 69);
                                    if (doubleArr.length === 5) {
                                        allMainDraws.push({ arr: doubleArr, year });
                                    }
                                }
                            }
                        }
                    }
                    csvLoading.textContent = '';
                    console.log('CSV data loaded, analyzing frequent sets...');
                    // Now analyze frequent sets
                    analyzeFrequentSets();
                    console.log('Frequent sets analysis complete');
                },
                error: function(error) {
                    console.log('Error parsing CSV:', error);
                }
            });
        });
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function generateUniqueNumbers(count, min, max, exclude=[]) {
        const nums = [];
        while (nums.length < count) {
            const num = Math.floor(Math.random() * (max - min + 1)) + min;
            if (!nums.includes(num) && !exclude.includes(num)) {
                nums.push(num);
            }
        }
        return nums.sort((a, b) => a - b);
    }

    function generateCombination() {
        const mainNumbers = generateUniqueNumbers(5, 1, 69);
        return { mainNumbers };
    }
    function countComboInHistory(whiteBalls) {
        const key = whiteBalls.slice().sort((a,b)=>a-b).join('-');
        return historicalCombos.filter(h => h.combo === key).length;
    }
    function generateFromFrequentTrios() {
        console.log('generateFromFrequentTrios called');
        console.log('window.sortedTriplets:', window.sortedTriplets);
        
        if (!window.sortedTriplets || window.sortedTriplets.length === 0) {
            console.error('No sortedTriplets data available');
            alert('Loading frequent trios data... Please try again in a moment.');
            return [1, 2, 3, 4, 5]; // Return a default set for testing
        }
        
        try {
            // Get top 10 most frequent trios
            const topTrios = window.sortedTriplets.slice(0, 10);
            console.log('Top 10 trios:', topTrios);
            
            if (topTrios.length === 0) {
                console.error('No trios available in topTrios');
                return [1, 2, 3, 4, 5]; // Return a default set for testing
            }
            
            const selectedTrio = topTrios[Math.floor(Math.random() * topTrios.length)];
            console.log('Selected trio:', selectedTrio);
            
            if (!selectedTrio || !selectedTrio[0]) {
                console.error('Invalid selectedTrio:', selectedTrio);
                return [1, 2, 3, 4, 5]; // Return a default set for testing
            }
            
            const [n1, n2, n3] = selectedTrio[0].split('-').map(Number);
            
            // Generate 2 more unique numbers not in the trio
            const exclude = [n1, n2, n3];
            const additionalNumbers = generateUniqueNumbers(2, 1, 69, exclude);
            
            const combination = [...[n1, n2, n3], ...additionalNumbers].sort((a, b) => a - b);
            console.log('Generated combination:', combination);
            return {
                combination: combination,
                basedOnTrio: `${n1}-${n2}-${n3}`
            };
        } catch (error) {
            console.error('Error in generateFromFrequentTrios:', error);
            return [1, 2, 3, 4, 5]; // Return a default set if there's an error
        }
    }
    
    // Track used trios to implement round-robin
    let usedTrios = new Set();
    let lastUsedTrioIndex = -1;
    
    function generateFromOverlappingTrios() {
        console.log('generateFromOverlappingTrios called');
        
        if (!window.sortedTriplets || window.sortedTriplets.length < 2) {
            console.error('Not enough trios available');
            alert('Not enough valid trios found in the data. Try with a larger date range or different settings.');
            return { combination: [1, 2, 3, 4, 5], basedOnTrio: 'Default (not enough valid trios)', isOverlap: false };
        }
        
        try {
            // 1. Get all trios regardless of frequency
            const validTrios = [...window.sortedTriplets];
            
            if (validTrios.length < 2) {
                console.log('Not enough trios available, using all available trios');
                validTrios.push(...window.sortedTriplets);
            }
        
            console.log('Using', validTrios.length, 'valid trios for overlapping');
            
            // 2. Try to find 2 or 3 trios that share 1 or 2 numbers
            let selectedTrios = [];
            let commonNumbers = [];
            const maxAttempts = 200;
            let attempts = 0;
            let foundMatch = false;
            
            // First try to find 3 trios with overlapping numbers
            while (attempts < maxAttempts && !foundMatch) {
                // Pick 3 different random trios
                const indices = [];
                while (indices.length < 3) {
                    const idx = Math.floor(Math.random() * validTrios.length);
                    if (!indices.includes(idx)) {
                        indices.push(idx);
                    }
                }
                
                const trio1 = validTrios[indices[0]];
                const trio2 = validTrios[indices[1]];
                const trio3 = validTrios[indices[2]];
                
                const nums1 = trio1[0].split('-').map(Number);
                const nums2 = trio2[0].split('-').map(Number);
                const nums3 = trio3[0].split('-').map(Number);
                
                // Find all unique numbers
                const allNums = [...new Set([...nums1, ...nums2, ...nums3])];
                
                // If we have 5 or fewer unique numbers, this is a good combination
                if (allNums.length <= 5) {
                    selectedTrios = [trio1, trio2, trio3];
                    commonNumbers = allNums;
                    foundMatch = true;
                    console.log('Found 3 trios with overlapping numbers:', allNums);
                    break;
                }
                
                attempts++;
            }
            
            // If no 3-trio match found, try with 2 trios
            if (!foundMatch) {
                console.log('No 3-trio match found, trying with 2 trios');
                attempts = 0;
                
                while (attempts < maxAttempts && !foundMatch) {
                    // Pick 2 different random trios
                    const index1 = Math.floor(Math.random() * validTrios.length);
                    let index2;
                    do {
                        index2 = Math.floor(Math.random() * validTrios.length);
                    } while (index2 === index1);
                    
                    const trio1 = validTrios[index1];
                    const trio2 = validTrios[index2];
                    
                    const nums1 = trio1[0].split('-').map(Number);
                    const nums2 = trio2[0].split('-').map(Number);
                    
                    // Find common numbers
                    const common = nums1.filter(num => nums2.includes(num));
                    
                    // If they share 1 or 2 numbers
                    if (common.length === 1 || common.length === 2) {
                        selectedTrios = [trio1, trio2];
                        commonNumbers = common;
                        foundMatch = true;
                        console.log(`Found 2 trios with ${common.length} common numbers:`, common);
                    }
                    
                    attempts++;
                }
            }
            
            // If still no match, fall back to any two trios
            if (!foundMatch) {
                console.log('Could not find overlapping trios, falling back to any two trios');
                const index1 = Math.floor(Math.random() * validTrios.length);
                let index2;
                do {
                    index2 = Math.floor(Math.random() * validTrios.length);
                } while (index2 === index1);
                
                selectedTrios = [validTrios[index1], validTrios[index2]];
                const nums1 = selectedTrios[0][0].split('-').map(Number);
                const nums2 = selectedTrios[1][0].split('-').map(Number);
                commonNumbers = nums1.filter(num => nums2.includes(num));
                
                if (commonNumbers.length === 0) {
                    // If no common numbers, just pick one from each trio
                    commonNumbers = [nums1[0], nums2[0]];
                }
            }
            
            // 3. Generate the final combination
            let combination;
            let basedOnTrio = '';
            
            // Get all unique numbers from selected trios
            const allNumbers = [...new Set(selectedTrios.flatMap(trio => 
                trio[0].split('-').map(Number)
            ))];
            
            if (allNumbers.length <= 5) {
                // If we have 5 or fewer unique numbers, use them all
                combination = allNumbers;
            } else {
                // Otherwise, prioritize the most common numbers
                const numberFrequencies = {};
                selectedTrios.forEach(trio => {
                    const nums = trio[0].split('-').map(Number);
                    nums.forEach(num => {
                        numberFrequencies[num] = (numberFrequencies[num] || 0) + 1;
                    });
                });
                
                // Sort numbers by frequency (descending) and take top 5
                combination = Object.entries(numberFrequencies)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([num]) => parseInt(num, 10));
            }
            
            // Fill in with random numbers if needed
            if (combination.length < 5) {
                const exclude = [...combination];
                const additional = generateUniqueNumbers(5 - combination.length, 1, 69, exclude);
                combination = [...combination, ...additional];
            }
            
            // Sort the final combination
            combination = combination.slice(0, 5).sort((a, b) => a - b);
            
            // Create the description
            basedOnTrio = selectedTrios.map(trio => {
                const [nums, freq] = trio;
                return `Trio (${freq}x): ${nums}`;
            }).join(' & ');
            
            if (commonNumbers.length > 0) {
                basedOnTrio += ` (${commonNumbers.length} common)`;
            }
            
            return {
                combination,
                basedOnTrio,
                isOverlap: true,
                frequency: Math.min(...selectedTrios.map(t => t[1]))
            };
            
        } catch (error) {
            console.error('Error in generateFromOverlappingTrios:', error);
            // Fallback to regular trio generation on error
            return generateFromFrequentTrios();
        }
    }
    
    function renderCombinations(n, useFrequentTrios = false, useOverlappingTrios = false) {
        // Ensure n is a valid number
        const count = parseInt(n, 10);
        if (isNaN(count) || count <= 0) {
            console.error('Invalid number of combinations to render:', n);
            return;
        }
        
        console.log(`Rendering ${count} combinations, useFrequentTrios: ${useFrequentTrios}`);
        
        const container = document.getElementById('generated-table');
        if (!container) {
            console.error('Could not find generated-table element');
            return;
        }
        
        // Ensure container is visible and cleared
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        container.innerHTML = '';
        
        // Create table element
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'separate';
        table.style.borderSpacing = '0 8px';
        table.style.margin = '0';
        table.style.tableLayout = 'fixed';
        
        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#f8f9fa';
        
        // Always create the Numbers header first
        const th2 = document.createElement('th');
        th2.textContent = 'Numbers';
        th2.style.textAlign = 'left';
        th2.style.padding = '12px 8px';
        th2.style.border = 'none';
        
        // Only add border radius if there's no trio info column
        if (!useFrequentTrios && !useOverlappingTrios) {
            th2.style.borderRadius = '0 8px 8px 0';
        } else {
            th2.style.borderRadius = '8px 0 0 8px';
        }
        
        headerRow.appendChild(th2);
        
        if (useFrequentTrios) {
            const th3 = document.createElement('th');
            th3.textContent = 'Based On Trio';
            th3.style.textAlign = 'left';
            th3.style.padding = '12px 8px';
            th3.style.border = 'none';
            th3.style.borderRadius = '0 8px 8px 0';
            headerRow.appendChild(th3);
        }
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');

        for (let i = 0; i < count; i++) {
            try {
                // Create combination based on frequent or overlapping trios
                let mainNumbers, basedOnTrio = '';
                
                if (useFrequentTrios || useOverlappingTrios) {
                    const result = useOverlappingTrios 
                        ? generateFromOverlappingTrios() 
                        : generateFromFrequentTrios();
                    
                    if (result && result.combination) {
                        mainNumbers = result.combination;
                        basedOnTrio = result.basedOnTrio || '';
                    } else {
                        console.error('Failed to generate combination from trios, falling back to random');
                        mainNumbers = generateCombination().mainNumbers;
                    }
                } else {
                    mainNumbers = generateCombination().mainNumbers;
                }

                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f5f5f5';
                tr.style.backgroundColor = 'white';
                tr.style.borderRadius = '8px';
                tr.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                tr.style.margin = '0';
                tr.style.display = 'table-row';
                
                // Add numbers cell
                const td2 = document.createElement('td');
                td2.textContent = mainNumbers.join(' - ');
                td2.style.padding = '12px 8px';
                td2.style.fontWeight = 'bold';
                td2.style.color = '#2c3e50';
                td2.style.border = 'none';
                td2.style.whiteSpace = 'nowrap';  // Prevent line breaks in numbers
                
                if (useFrequentTrios || useOverlappingTrios) {
                    td2.style.borderRadius = '8px 0 0 8px';  // Rounded left corners when there's a trio info column
                } else {
                    td2.style.borderRadius = '8px';  // Rounded corners when it's the only column
                }
                tr.appendChild(td2);
                
                // Add trio info if needed
                if (useFrequentTrios || useOverlappingTrios) {
                    const td3 = document.createElement('td');
                    td3.textContent = basedOnTrio;
                    td3.style.padding = '12px 8px';
                    td3.style.color = '#9b59b6';
                    td3.style.fontWeight = '500';
                    td3.style.border = 'none';
                    td3.style.borderRadius = '0 8px 8px 0';
                    tr.appendChild(td3);
                }
                
                tbody.appendChild(tr);
            } catch (error) {
                console.error(`Error generating combination ${i+1}:`, error);
            }
        }
        
        table.appendChild(tbody);
        
        // Create a wrapper div for better control
        const tableWrapper = document.createElement('div');
        tableWrapper.style.overflowX = 'auto';
        tableWrapper.style.width = '100%';
        tableWrapper.appendChild(table);
        
        // Clear and append the table
        container.innerHTML = '';
        container.appendChild(tableWrapper);
        
        // Force a reflow to ensure the table is rendered
        void container.offsetHeight;
        
        console.log('Table rendered with', count, 'combinations');
        console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
    }
    
    // Handle regular number generation buttons
    document.querySelectorAll('.multi-gen-btn:not(#generate-from-trios):not(#generate-from-overlapping-trios)').forEach(btn => {
        btn.onclick = function() {
            const count = parseInt(this.getAttribute('data-count') || '1', 10);
            renderCombinations(count);
        };
    });
    
    // Handle overlapping trios button
    document.getElementById('generate-from-overlapping-trios').addEventListener('click', function() {
        renderCombinations(5, false, true);
    });
    
    // Handle frequent trios button
    function initializeTrioButton() {
        const generateFromTriosBtn = document.getElementById('generate-from-trios');
        console.log('Trio button element:', generateFromTriosBtn);
        if (generateFromTriosBtn) {
            // Remove any existing click handlers to prevent duplicates
            const newBtn = generateFromTriosBtn.cloneNode(true);
            generateFromTriosBtn.parentNode.replaceChild(newBtn, generateFromTriosBtn);
            
            console.log('Adding click handler to trio button');
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Trio button clicked');
                console.log('sortedTriplets available:', window.sortedTriplets ? 'Yes' : 'No');
                if (window.sortedTriplets) {
                    console.log('Number of available trios:', window.sortedTriplets.length);
                    // Clear any previous error messages
                    const container = document.getElementById('generated-table');
                    if (container) {
                        container.innerHTML = '';
                    }
                    // Render new combinations
                    renderCombinations(5, true);
                } else {
                    console.error('No sortedTriplets data available');
                    const container = document.getElementById('generated-table');
                    if (container) {
                        container.innerHTML = '<div style="color: #e74c3c; padding: 15px; text-align: center;">Loading data... Please try again in a moment.</div>';
                    }
                }
            });
        } else {
            console.error('Could not find generate-from-trios button');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        // Initialize the trio button
        initializeTrioButton();
        
        // Show home tab by default (guard for missing elements)
        const homeTab = document.getElementById('home-tab');
        if (homeTab) homeTab.style.display = 'block';
        const historyTab = document.getElementById('history-tab');
        if (historyTab) historyTab.style.display = 'none';
        // Do NOT call analyzeFrequentSets here. It is called after CSV loads.
        
        // Add click handlers for generate buttons
        document.querySelectorAll('.multi-gen-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const count = parseInt(this.getAttribute('data-count'), 10);
                renderCombinations(count);
            });
        });
        // Add clear/deselect handlers for Section 2 and 3
        const clearDuoBtn = document.getElementById('clear-duo-selection-btn');
        if (clearDuoBtn) {
            clearDuoBtn.onclick = function() {
                const duo1Select = document.getElementById('duo1-select');
                const duo2Select = document.getElementById('duo2-select');
                duo1Select.selectedIndex = -1;
                duo2Select.selectedIndex = -1;
                document.getElementById('built-duo-combo-result').innerHTML = '';
                document.getElementById('build-duo-combo-btn').disabled = true;
            };
        }
        const clearComboBtn = document.getElementById('clear-combo-selection-btn');
        if (clearComboBtn) {
            clearComboBtn.onclick = function() {
                const comboDuoSelect = document.getElementById('combo-duo-select');
                const comboTrioSelect = document.getElementById('combo-trio-select');
                comboDuoSelect.selectedIndex = -1;
                comboTrioSelect.selectedIndex = -1;
                document.getElementById('built-combo-result').innerHTML = '';
                document.getElementById('build-combo-btn').disabled = true;
            };
        }

        // Tab switching logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // For history tab
                if (this.getAttribute('data-tab') === 'history') {
                    document.getElementById('home-tab').style.display = 'none';
                    document.getElementById('history-tab').style.display = 'block';
                    renderHistoryTable();
                } else {
                    document.getElementById('home-tab').style.display = 'block';
                    document.getElementById('history-tab').style.display = 'none';
                }
            });
        });

        // Add event listener for building combinations from duos
        const buildDuoBtn = document.getElementById('build-duo-combo-btn');
        if (buildDuoBtn) {
            buildDuoBtn.addEventListener('click', function() {
                const duo1Val = document.getElementById('duo1-select').value;
                const duo2Val = document.getElementById('duo2-select').value;
                if (!duo1Val || !duo2Val) {
                    alert('Please select two valid duos to combine');
                    return;
                }
                const duo1 = duo1Val.split('-').map(Number);
                const duo2 = duo2Val.split('-').map(Number);
                if (duo1.length === 2 && duo2.length === 2) {
                    const combined = [...new Set([...duo1, ...duo2])];
                    if (combined.length === 4) {
                        const result = document.getElementById('built-duo-combo-result');
                        result.innerHTML = `
                            <div class="result-card fade-in">
                                <div class="result-title">Generated Combination</div>
                                <div class="result-balls">
                                    ${combined.sort((a,b) => a-b).map(n => `<span class='generated-ball'>${n}</span>`).join(' ')}
                                </div>
                            </div>
                        `;
                        return;
                    }
                }
                alert('Please select two valid duos to combine');
            });
            // Enable/disable build button logic
            const duo1Select = document.getElementById('duo1-select');
            const duo2Select = document.getElementById('duo2-select');
            [duo1Select, duo2Select].forEach(sel => sel.addEventListener('change', function() {
                buildDuoBtn.disabled = !(duo1Select.value && duo2Select.value);
            }));
        }
        // Section 3: Combo build button logic
        const buildComboBtn = document.getElementById('build-combo-btn');
        if (buildComboBtn) {
            buildComboBtn.addEventListener('click', function() {
                const duoVal = document.getElementById('combo-duo-select').value;
                const trioVal = document.getElementById('combo-trio-select').value;
                if (!duoVal || !trioVal) {
                    alert('Please select a valid duo and trio to combine');
                    return;
                }
                const duo = duoVal.split('-').map(Number);
                const trio = trioVal.split('-').map(Number);
                if (duo.length === 2 && trio.length === 3) {
                    const combined = [...new Set([...duo, ...trio])];
                    if (combined.length === 5) {
                        const result = document.getElementById('built-combo-result');
                        result.innerHTML = `
    <div class="result-card fade-in">
        <div class="result-title">Generated Combination</div>
        <div class="result-balls">
            ${combined.sort((a,b) => a-b).map(n => `<span class='generated-ball'>${n}</span>`).join(' ')}
        </div>
    </div>
`;
                        return;
                    }
                }
                alert('Please select a valid duo and trio to combine');
            });
            // Enable/disable build button logic
            const comboDuoSelect = document.getElementById('combo-duo-select');
            const comboTrioSelect = document.getElementById('combo-trio-select');
            [comboDuoSelect, comboTrioSelect].forEach(sel => sel.addEventListener('change', function() {
                buildComboBtn.disabled = !(comboDuoSelect.value && comboTrioSelect.value);
            }));
        }
    });

    // History tab rendering
    function renderHistoryTable() {
        const historyContent = document.getElementById('history-content');
        if (!historyContent) return;
        
        let html = '<table class="freq-table" style="width:100%;"><thead><tr><th>#</th><th>Numbers</th></tr></thead><tbody>';
        allMainDraws.forEach((nums, idx) => {
            html += `<tr><td>${idx+1}</td><td><div class="aligned-numbers">${nums.map((num, i) => `<span class='plain-number'>${num}</span>${i < nums.length - 1 ? '<b style=\"color:#000;font-size:1.2em;\">-</b>' : ''}`).join('')}</div></td></tr>`;
        });
        html += '</tbody></table>';
        historyContent.innerHTML = html;
    }

    // Function to analyze frequent sets and populate dropdowns
    function analyzeFrequentSets() {
        console.log('Starting analyzeFrequentSets...');
        // Analyze and track actual trios that appeared together in a single draw
        const actualTrios = new Map(); // Store actual trios from draws
        const pairCounts = new Map();
        const tripletCounts = new Map();
        console.log('Number of draws to analyze:', allMainDraws.length);
        
        // First pass: Collect all actual trios that appeared together
        const filteredDraws = allMainDraws.filter(d => d.year >= 2016 && d.year <= 2025);
        filteredDraws.forEach(drawObj => {
            const sortedDraw = [...drawObj.arr].sort((a, b) => a - b);
            
            // Track all trios that actually appeared together in this draw
            for (let i = 0; i < sortedDraw.length - 2; i++) {
                for (let j = i + 1; j < sortedDraw.length - 1; j++) {
                    for (let k = j + 1; k < sortedDraw.length; k++) {
                        const trio = [sortedDraw[i], sortedDraw[j], sortedDraw[k]];
                        const trioKey = trio.join('-');
                        actualTrios.set(trioKey, true);
                    }
                }
            }
        });
        
        console.log('Found', actualTrios.size, 'unique trios that appeared in actual draws');
        
        // Second pass: Count frequencies of actual trios
        filteredDraws.forEach(drawObj => {
            const sortedDraw = [...drawObj.arr].sort((a, b) => a - b);
            
            // Count pairs (for other functionality)
            for (let i = 0; i < sortedDraw.length; i++) {
                for (let j = i + 1; j < sortedDraw.length; j++) {
                    const pair = [sortedDraw[i], sortedDraw[j]];
                    const pairKey = pair.join('-');
                    pairCounts.set(pairKey, (pairCounts.get(pairKey) || 0) + 1);
                }
            }
            
            // Only count trios that we've seen in actual draws
            const seenTrios = new Set(); // Avoid counting same trio multiple times in one draw
            for (let i = 0; i < sortedDraw.length - 2; i++) {
                for (let j = i + 1; j < sortedDraw.length - 1; j++) {
                    for (let k = j + 1; k < sortedDraw.length; k++) {
                        const trio = [sortedDraw[i], sortedDraw[j], sortedDraw[k]];
                        const trioKey = trio.join('-');
                        if (actualTrios.has(trioKey) && !seenTrios.has(trioKey)) {
                            tripletCounts.set(trioKey, (tripletCounts.get(trioKey) || 0) + 1);
                            seenTrios.add(trioKey);
                        }
                    }
                }
            }
        });
        
        // Convert to arrays and sort by frequency (descending)
        const sortedPairs = Array.from(pairCounts.entries())
            .filter(([_, count]) => count >= 1)  // Include all actual pairs
            .sort((a, b) => b[1] - a[1]);
            
        // Only include trios that actually appeared together in a draw
        window.sortedTriplets = Array.from(tripletCounts.entries())
            .filter(([trioKey, count]) => actualTrios.has(trioKey) && count >= 1)  // Only actual trios that appeared at least once
            .sort((a, b) => b[1] - a[1]);
            
        console.log('Found', sortedPairs.length, 'frequent pairs and', window.sortedTriplets.length, 'frequent trios');
        
        // Populate duo select dropdowns with improved UI
        const duo1Select = document.getElementById('duo1-select');
        const duo2Select = document.getElementById('duo2-select');
        const comboDuoSelect = document.getElementById('combo-duo-select');
        const comboTrioSelect = document.getElementById('combo-trio-select');
        
        // Section 2: Populate duo dropdowns
        if (duo1Select && duo2Select) {
            duo1Select.innerHTML = '<option value="">Select First Duo</option>';
            duo2Select.innerHTML = '<option value="">Select Second Duo</option>';
            sortedPairs.forEach(([pairKey, count]) => {
                const option1 = document.createElement('option');
                option1.value = pairKey;
                option1.textContent = `${pairKey.replace(/-/g, ' - ')} (${count}×)`;
                duo1Select.appendChild(option1.cloneNode(true));
                duo2Select.appendChild(option1);
            });
            duo1Select.selectedIndex = -1;
            duo2Select.selectedIndex = -1; // No selection by default
        }
        // Section 3: Populate duo and trio dropdowns
        if (comboDuoSelect && comboTrioSelect) {
            comboDuoSelect.innerHTML = '<option value="">Select Duo</option>';
            comboTrioSelect.innerHTML = '<option value="">Select Trio</option>';
            sortedPairs.forEach(([pairKey, count]) => {
                const option = document.createElement('option');
                option.value = pairKey;
                option.textContent = `${pairKey.replace(/-/g, ' - ')} (${count}×)`;
                comboDuoSelect.appendChild(option);
            });
            sortedTriplets.forEach(([trioKey, count]) => {
                const option = document.createElement('option');
                option.value = trioKey;
                option.textContent = `${trioKey.replace(/-/g, ' - ')} (${count}×)`;
                comboTrioSelect.appendChild(option);
            });
            comboDuoSelect.selectedIndex = -1;
            comboTrioSelect.selectedIndex = -1; // No selection by default
        }
            // Initialize Choices.js on all dropdowns (only once)
        [duo1Select, duo2Select, comboDuoSelect, comboTrioSelect].forEach(sel => {
            if (sel && !sel.classList.contains('choices-initialized')) {
                // Create a simple select element without Choices.js
                sel.style.display = 'block';
                sel.style.width = '100%';
                sel.style.padding = '8px';
                sel.style.borderRadius = '4px';
                sel.style.border = '1px solid #ddd';
                sel.style.marginBottom = '10px';
                
                // Add search input above the select
                const searchContainer = document.createElement('div');
                searchContainer.style.marginBottom = '8px';
                
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Search for a number...';
                searchInput.style.width = '100%';
                searchInput.style.padding = '8px';
                searchInput.style.border = '1px solid #ddd';
                searchInput.style.borderRadius = '4px';
                
                // Store original options
                const originalOptions = Array.from(sel.options);
                
                // Add event listener for search
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();
                    
                    // Clear current options
                    while (sel.options.length > 0) {
                        sel.remove(0);
                    }
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = sel.getAttribute('data-placeholder') || 'Select an option';
                    sel.appendChild(defaultOption);
                    
                    // Filter and add matching options
                    if (searchTerm === '') {
                        // Show all options if search is empty
                        originalOptions.forEach(opt => {
                            if (opt.value !== '') {
                                sel.appendChild(opt.cloneNode(true));
                            }
                        });
                    } else if (/^\d+$/.test(searchTerm)) {
                        // Only filter if search term is a number
                        originalOptions.forEach(opt => {
                            if (opt.value === '') return;
                            
                            // Check if any number in the option matches exactly
                            const numbers = opt.value.split('-');
                            if (numbers.includes(searchTerm)) {
                                sel.appendChild(opt.cloneNode(true));
                            }
                        });
                    }
                    
                    // Trigger change event
                    const event = new Event('change');
                    sel.dispatchEvent(event);
                });
                
                // Add elements to the DOM
                searchContainer.appendChild(searchInput);
                sel.parentNode.insertBefore(searchContainer, sel);
                sel.classList.add('choices-initialized');
            }
        });
        // Add a count of available pairs
        const pairCountElement = document.createElement('div');
            pairCountElement.style.fontSize = '0.9em';
            pairCountElement.style.color = '#4a5568';
            pairCountElement.style.marginTop = '8px';
            pairCountElement.textContent = `Showing ${sortedPairs.length} frequent pairs (appearing 2+ times)`;
            duo1Select.parentNode.insertBefore(pairCountElement, duo1Select.nextSibling);
            // Enable the build button when both duos are selected
            const buildDuoBtn = document.getElementById('build-duo-combo-btn');
            if (buildDuoBtn) {
                const updateBuildButtonState = () => {
                    buildDuoBtn.disabled = !(duo1Select.value && duo2Select.value);
                };
                duo1Select.addEventListener('change', updateBuildButtonState);
                duo2Select.addEventListener('change', updateBuildButtonState);
            }
        }
    
    </script>
    <script>
    // Defer non-critical JavaScript loading
    document.addEventListener('DOMContentLoaded', function() {
        // Load Choices.js after the page is interactive
        const choicesScript = document.createElement('script');
        choicesScript.src = 'https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js';
        choicesScript.onload = function() {
            console.log('Choices.js loaded');
            // Initialize any Choices.js instances here if needed
        };
        document.body.appendChild(choicesScript);

        // Optimize touch interactions
        document.documentElement.style.touchAction = 'manipulation';
        
        // Add passive event listeners for better scrolling performance
        const addPassiveEventListener = (element, event, handler) => {
            const supportsPassive = false;
            try {
                const opts = Object.defineProperty({}, 'passive', {
                    get: function() { supportsPassive = true; }
                });
                window.addEventListener('test', null, opts);
                window.removeEventListener('test', null, opts);
            } catch (e) {}
            
            element.addEventListener(event, handler, supportsPassive ? { passive: true } : false);
        };

        // Optimize window resize
        let resizeTimeout;
        addPassiveEventListener(window, 'resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Handle resize logic here if needed
            }, 250);
        });

        // Optimize scroll performance
        addPassiveEventListener(window, 'scroll', function() {
            // Handle scroll logic here if needed
        }, { passive: true });

        // Optimize button clicks for mobile
        document.querySelectorAll('button, a, [role="button"]').forEach(button => {
            button.style.webkitTapHighlightColor = 'transparent';
            button.addEventListener('touchstart', function() {
                this.classList.add('active');
            }, { passive: true });
            button.addEventListener('touchend', function() {
                this.classList.remove('active');
            }, { passive: true });
        });
    });

    // Optimize animation frame usage
    (function() {
        let lastScrollTop = 0;
        const delta = 5;
        
        function checkScroll() {
            const st = window.scrollY;
            
            if (Math.abs(lastScrollTop - st) <= delta) {
                return; // No significant scroll
            }
            
            // Handle scroll direction
            if (st > lastScrollTop && st > 0) {
                // Scrolling down
            } else {
                // Scrolling up
            }
            
            lastScrollTop = st <= 0 ? 0 : st;
        }
        
        // Throttle the scroll event
        let ticking = false;
        window.addEventListener('scroll', function() {
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    checkScroll();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
    })();
    </script>
</body>
</html>